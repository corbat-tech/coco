# Auditoría Tools v1

**Fecha**: 2026-02-02
**Auditor**: Claude Opus 4.5
**Versión**: v0.1.0
**Iteración**: 1
**Score actual**: 68/100
**Status**: CONTINUE

---

## Resumen Ejecutivo

Primera auditoría del sistema de herramientas de Corbat-Coco. Se han identificado 27 herramientas distribuidas en 5 categorías. El score inicial de 68/100 indica una base sólida pero con gaps críticos en seguridad y completitud.

---

## Inventario de Herramientas

| Categoría | Herramientas | Cantidad |
|-----------|-------------|----------|
| file | read_file, write_file, edit_file, glob, file_exists, list_dir, delete_file | 7 |
| bash | bash_exec, bash_background, command_exists, get_env | 4 |
| git | git_status, git_diff, git_add, git_commit, git_log, git_branch, git_checkout, git_push, git_pull, git_init | 10 |
| test | run_tests, get_coverage, run_test_file | 3 |
| quality | run_linter, analyze_complexity, calculate_quality | 3 |
| **Total** | | **27** |

---

## Evaluación por Criterio

### 1. Completeness (Peso: 25%) - Score: 7/10

| Área | Estado | Notas |
|------|--------|-------|
| File operations | ✅ | CRUD completo + glob + exists + listDir |
| Shell execution | ✅ | Sync + background + command check + env |
| Version control | ✅ | 10 git tools, cobertura completa |
| Testing | ✅ | Run tests, coverage, single file |
| Quality analysis | ✅ | Lint, complexity, full quality |
| **Search/grep** | ❌ P0 | No hay herramienta de búsqueda en contenido |
| HTTP/API tools | ❌ | No hay fetch/curl tool |
| Build tools | ❌ | Categoría definida pero sin implementar |
| Deploy tools | ❌ | Categoría definida pero sin implementar |

**Benchmark vs Claude Code**:
- Claude Code tiene: Read, Write, Edit, Glob, Grep, Bash, TodoRead, TodoWrite
- Corbat-Coco falta: **Grep** (crítico)

### 2. Safety (Peso: 25%) - Score: 6/10

| Control | Estado | Ubicación |
|---------|--------|-----------|
| Dangerous command blocking | ✅ | `bash.ts:24-31` - rm -rf /, fork bombs, dd, mkfs |
| Timeout protection | ✅ | `bash.ts:14` - DEFAULT_TIMEOUT_MS = 120000 |
| Output size limits | ✅ | `bash.ts:19` - MAX_OUTPUT_SIZE = 1MB |
| Zod parameter validation | ✅ | `registry.ts:122` - parse antes de execute |
| **Path traversal protection** | ❌ P0 | File tools aceptan cualquier path absoluto |
| **Sensitive file protection** | ❌ | No bloquea .env, secrets, credentials |
| **Delete confirmation** | ❌ P0 | delete_file no pide confirmación |
| Rate limiting | ❌ | Sin límites de llamadas |

**Patrones peligrosos bloqueados**:
```typescript
const DANGEROUS_PATTERNS = [
  /\brm\s+-rf\s+\/(?!\w)/,   // rm -rf / (root)
  /\bsudo\s+rm\s+-rf/,       // sudo rm -rf
  /\b:?\(\)\s*\{.*\}/,       // Fork bomb
  /\bdd\s+if=.*of=\/dev\//,  // dd to device
  /\bmkfs\./,                // Format filesystem
];
```

### 3. Performance (Peso: 25%) - Score: 7/10

| Aspecto | Estado | Valor |
|---------|--------|-------|
| Bash timeout configurable | ✅ | Default 2min, max configurable |
| Output truncation | ✅ | `truncateOutput()` at 50K chars |
| Test timeout | ✅ | 5 minutes |
| Lint timeout | ✅ | 2 minutes |
| Default ignores | ✅ | node_modules, .git en glob |
| Duration tracking | ✅ | `registry.ts:128-129` |
| **File size limits** | ❌ | read_file sin límite |
| Streaming for large files | ❌ | Lee todo en memoria |
| Parallel tool execution | ✅ | Registry soporta, usado en quality |

### 4. UX (Peso: 25%) - Score: 7/10

| Aspecto | Estado | Notas |
|---------|--------|-------|
| Parameter descriptions | ✅ | Zod .describe() en todos los params |
| Consistent ToolResult | ✅ | `{ success, data?, error?, duration }` |
| Custom error types | ✅ | FileSystemError, ToolError, TimeoutError |
| LLM-friendly definitions | ✅ | `getToolDefinitionsForLLM()` |
| Rich return metadata | ✅ | lines, size, exitCode, etc. |
| Progress reporting | ❌ | Sin callbacks de progreso |
| Dry-run mode | ❌ | Sin preview de operaciones destructivas |
| Tool examples | ❌ | Sin ejemplos de uso |

---

## Cálculo del Score

| Criterio | Peso | Score | Ponderado |
|----------|------|-------|-----------|
| Completeness | 25% | 7/10 | 17.5 |
| Safety | 25% | 6/10 | 15.0 |
| Performance | 25% | 7/10 | 17.5 |
| UX | 25% | 7/10 | 17.5 |
| **Total** | 100% | | **67.5 → 68** |

---

## P0: Críticos (bloquean convergencia)

| ID | Descripción | Impacto | Archivo |
|----|-------------|---------|---------|
| P0-1 | Implementar grep/search tool | +5 completeness | Nuevo: `search.ts` |
| P0-2 | Path sanitization en file tools | +4 safety | `file.ts` |
| P0-3 | Confirmación para delete_file | +2 safety | `file.ts` |

### P0-1: Grep Tool

Crítico para exploración de código. Benchmark: Claude Code's Grep tool.

```typescript
// Propuesta: src/tools/search.ts
export const grepTool = defineTool({
  name: "grep",
  description: "Search for text patterns in files",
  category: "file",
  parameters: z.object({
    pattern: z.string().describe("Regex pattern to search"),
    path: z.string().optional().describe("Directory or file to search"),
    include: z.string().optional().describe("File glob pattern (e.g. '*.ts')"),
    contextLines: z.number().optional().default(0).describe("Lines of context"),
    maxResults: z.number().optional().default(100).describe("Maximum results"),
  }),
  async execute({ pattern, path, include, contextLines, maxResults }) {
    // Use ripgrep or native implementation
  }
});
```

### P0-2: Path Sanitization

File tools actualmente aceptan cualquier path absoluto, permitiendo leer/escribir fuera del proyecto.

```typescript
// Propuesta: agregar a file.ts
const BLOCKED_PATHS = [
  '/etc/',
  '/var/',
  '/usr/',
  '/root/',
  '/home/',
  process.env.HOME,
];

function isPathAllowed(filePath: string, projectRoot: string): boolean {
  const absolute = path.resolve(filePath);

  // Must be within project
  if (!absolute.startsWith(projectRoot)) {
    return false;
  }

  // Check blocked paths
  for (const blocked of BLOCKED_PATHS) {
    if (blocked && absolute.startsWith(blocked)) {
      return false;
    }
  }

  return true;
}
```

### P0-3: Delete Confirmation

delete_file debería requerir confirmación explícita para directorios.

```typescript
// Propuesta: modificar deleteFileTool
parameters: z.object({
  path: z.string().describe("Path to delete"),
  recursive: z.boolean().optional().default(false),
  confirm: z.boolean().describe("Must be true to confirm deletion"), // NUEVO
}),
async execute({ path: filePath, recursive, confirm }) {
  if (!confirm) {
    throw new ToolError("Deletion requires explicit confirmation (confirm: true)", {
      tool: "delete_file",
    });
  }
  // ... rest of implementation
}
```

---

## P1: Importantes

| ID | Descripción | Impacto |
|----|-------------|---------|
| P1-1 | Implementar HTTP/fetch tool | +2 completeness |
| P1-2 | File size limits en read_file | +2 performance |
| P1-3 | Sensitive file protection (.env) | +2 safety |
| P1-4 | Dry-run mode para operaciones destructivas | +1 UX |

---

## P2: Nice to have

| ID | Descripción |
|----|-------------|
| P2-1 | Build tools category implementation |
| P2-2 | Tool usage examples in descriptions |
| P2-3 | Progress reporting callbacks |
| P2-4 | Tool execution rate limiting |

---

## Tests

```
pnpm check: PASS
- Typecheck: ✓
- Lint: 0 errors
- Tests: 1215 passed (52 test files)
```

---

## Archivos Auditados

```
src/tools/
├── index.ts       # Exports + registerAllTools
├── registry.ts    # ToolRegistry class
├── file.ts        # 7 file tools
├── bash.ts        # 4 bash tools
├── git.ts         # 10 git tools
├── test.ts        # 3 test tools
└── quality.ts     # 3 quality tools
```

---

## Comparación con Benchmarks

| Feature | Corbat-Coco | Claude Code | Devin |
|---------|-------------|-------------|-------|
| File CRUD | ✅ | ✅ | ✅ |
| Glob search | ✅ | ✅ | ✅ |
| **Content search (grep)** | ❌ | ✅ | ✅ |
| Shell execution | ✅ | ✅ | ✅ |
| Git operations | ✅ | ✗ (bash) | ✅ |
| Test execution | ✅ | ✗ (bash) | ✅ |
| Dangerous cmd blocking | ✅ | ✅ | ✅ |
| Path sanitization | ❌ | ✅ | ✅ |
| Timeout protection | ✅ | ✅ | ✅ |

---

## Plan de Mejora (Iteración 2)

### Objetivo: Score >= 78 (necesitamos +10)

1. **P0-1: Grep tool** (+5 puntos)
   - Crear `src/tools/search.ts`
   - Implementar grep con ripgrep fallback
   - Añadir a exports e index

2. **P0-2: Path sanitization** (+4 puntos)
   - Crear función `isPathAllowed()`
   - Aplicar a todas las file tools
   - Tests para path traversal

3. **P0-3: Delete confirmation** (+2 puntos)
   - Añadir param `confirm` requerido
   - Error claro si no confirmado

### Implementación estimada: ~90 líneas de código

---

## Decisión: CONTINUE

| Criterio | Valor | Resultado |
|----------|-------|-----------|
| Score >= 85 | 68 < 85 | ✗ |
| Delta < 2 | N/A (primera iteración) | - |
| Iteración >= 5 | 1 < 5 | ✗ |

**→ CONTINUE** - Implementar P0s para siguiente iteración

---

*Generado por Corbat-Coco Audit System*
