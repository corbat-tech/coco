# Auditor√≠a UX Corbat-Coco REPL v2

**Fecha**: 2026-02-02
**Auditor**: Claude Opus 4.5
**Versi√≥n**: v0.1.0
**√Åreas**: Spinner, Cancellation, Confirmation, Tool Output
**Score anterior**: N/A (primera auditor√≠a)
**Score actual**: 58/100
**Delta**: N/A

---

## Resumen ejecutivo

El REPL tiene las bases funcionales implementadas, pero carece de la sofisticaci√≥n de agentes profesionales. Las 4 mejoras est√°n implementadas pero de forma b√°sica. Los gaps m√°s importantes son: ausencia de diffs visuales para edits, falta de elapsed time en el spinner, y sistema de permisos sin persistencia.

## Evaluaci√≥n de mejoras implementadas

### 1. Spinner (Thinking indicator)
- **Score**: 5/10
- **Implementaci√≥n**: Parcial
- **Archivos**: `src/cli/repl/output/spinner.ts`, `src/cli/repl/index.ts`
- **Observaciones**:
  - ‚úì Animaci√≥n Braille funcional (80ms refresh)
  - ‚úì Se limpia correctamente al terminar (`\r\x1b[K`)
  - ‚úó **No muestra elapsed time** - Claude Code muestra "Thinking... (3s)"
  - ‚úó No hay estados din√°micos ("Analyzing...", "Generating...")
  - ‚úó Desaparece sin feedback del tiempo que tard√≥
  - ‚úó No hay indicador de progreso para multi-tool operations

### 2. Ctrl+C cancellation
- **Score**: 6/10
- **Implementaci√≥n**: Parcial
- **Archivos**: `src/cli/repl/index.ts:96-108`, `src/cli/repl/agent-loop.ts`
- **Observaciones**:
  - ‚úì AbortController correctamente integrado
  - ‚úì Handler se registra/remueve por turn (`process.once/off`)
  - ‚úì Limpia spinner al abortar
  - ‚úó **No cancela durante readline** en confirmations (bloquea)
  - ‚úó No muestra trabajo completado antes de cancelar
  - ‚úó No hay graceful degradation (partial response)
  - ‚úó El check `signal.aborted` solo ocurre al inicio del loop de tools

### 3. Confirmation system
- **Score**: 6/10
- **Implementaci√≥n**: Parcial
- **Archivos**: `src/cli/repl/confirmation.ts`, `src/cli/repl/agent-loop.ts`
- **Observaciones**:
  - ‚úì 4 opciones: yes/no/all/cancel
  - ‚úì Estado `allowAll` per-turn funciona
  - ‚úì Formateo visual con colores por tipo
  - ‚úó **No hay preview del contenido** a escribir/editar
  - ‚úó No hay trust levels persistentes (session/always)
  - ‚úó delete_file tiene mismo nivel que write_file (deber√≠a ser m√°s severo)
  - ‚úó No hay timeout - puede bloquear indefinidamente
  - ‚úó Readline crea nueva instancia cada vez (ineficiente)

### 4. Tool output formatting
- **Score**: 6/10
- **Implementaci√≥n**: Parcial
- **Archivos**: `src/cli/repl/output/renderer.ts`
- **Observaciones**:
  - ‚úì Iconos por tool type (üìÑüìùüóëÔ∏è‚ö°)
  - ‚úì Summaries inteligentes (path, comando truncado)
  - ‚úì Previews: "(X lines)", "(saved)", "(X matches)"
  - ‚úì Duration display
  - ‚úó **No hay diffs visuales** para edit_file
  - ‚úó No hay syntax highlighting
  - ‚úó No distingue create vs modify
  - ‚úó No muestra file sizes
  - ‚úó Outputs largos no son colapsables

## Gaps vs Claude Code

| √Årea | Estado actual | Claude Code | Gap |
|------|---------------|-------------|-----|
| Elapsed time | No implementado | "Thinking... (Xs)" din√°mico | **Cr√≠tico** |
| Diffs para edits | No implementado | Diff visual antes/despu√©s con +/- | **Cr√≠tico** |
| Trust levels | Solo per-turn | Session/always/never persistente | **Alto** |
| Preview en confirm | Solo muestra path | Muestra contenido truncado | **Alto** |
| Syntax highlighting | No | S√≠ (Markdown, c√≥digo) | **Medio** |
| Partial results | No | S√≠, muestra lo completado al cancelar | **Medio** |
| Cost estimation | No | Muestra $X.XX estimado | **Bajo** |
| Markdown streaming | Solo texto plano | Renderiza bold/italic/code en stream | **Bajo** |

## Recomendaciones priorizadas

### P0 - Cr√≠tico (bloquean UX b√°sica)

1. **Agregar elapsed time al spinner**
   - Modificar `spinner.ts` para trackear `Date.now()` al start
   - Actualizar mensaje: `"Thinking... (${elapsed}s)"`

2. **Implementar diffs visuales para edits**
   - Antes de edit_file, mostrar `- old_line` / `+ new_line`
   - Usar colores: rojo para deleted, verde para added

3. **Fix Ctrl+C durante confirmations**
   - Usar `rl.on('SIGINT')` dentro de `confirmToolExecution`
   - O cambiar a library que soporte async cancel

### P1 - Importante (mejora significativa)

4. **Trust levels persistentes**
   - Agregar opci√≥n "[t]rust this session" en confirmation
   - Guardar en `session.trustedTools: Set<string>`

5. **Preview de contenido en confirmations**
   - Para write_file: mostrar primeras 5-10 l√≠neas
   - Para edit_file: mostrar diff antes de preguntar

6. **Mostrar trabajo completado al cancelar**
   - Antes de return con `aborted: true`, imprimir resumen

### P2 - Nice to have

7. **Niveles de riesgo por tool**
8. **Cost estimation**
9. **Syntax highlighting b√°sico**

## Score global: 58/100

**Breakdown:**
| √Årea | Peso | Score | Ponderado |
|------|------|-------|-----------|
| Spinner | 25% | 5/10 | 12.5 |
| Cancellation | 25% | 6/10 | 15.0 |
| Confirmation | 25% | 6/10 | 15.0 |
| Tool output | 25% | 6/10 | 15.0 |
| **Total** | 100% | | **57.5 ‚âà 58** |

---

## Pr√≥ximos pasos

Para la pr√≥xima auditor√≠a, implementar todos los items P0 deber√≠a subir el score a ~73/100.
Implementar P0 + P1 parcial llevar√≠a a ~80/100 (nivel profesional).

## Criterio de convergencia

- **Target**: ‚â•85/100
- **Delta m√≠nimo para parar**: <2 puntos entre auditor√≠as consecutivas (alineado con Corbat-Coco core)
- **Max iteraciones**: 5 ciclos de auditor√≠a
